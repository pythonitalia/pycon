{% extends "admin/base_site.html" %}
{% load i18n %}
{% load markdownify %}
{% load localize countryname get_item %}
{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
  &rsaquo; <a href="{% url 'admin:app_list' 'reviews' %}">Reviews</a>
  &rsaquo; <a href="{% url 'admin:reviews_reviewsession_changelist' %}">Review sessions</a>
  &rsaquo; <a href="{% url 'admin:reviews_reviewsession_change' review_session_id %}">{{review_session_repr}}</a>
  &rsaquo; {{title}}
</div>
{% endblock %}
{% block content %}

<style>
  * {
    box-sizing: border-box;
  }

  .results-table {
    width: 100%;
  }

  .decision-input-wrapper label {
    display: block;
  }

  .decision-input-wrapper input {
    width: 20px;
    height: 20px;
    margin-right: 5px;
  }

  .reviews-bottom-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 500;
    background-color: #417690;
    color: #fff;
  }

  .reviews-bottom-bar-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .reviews-bottom-bar-stats {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 50px;
  }

  .reviews-bottom-bar-confirm-bar {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
    max-width: 800px;
  }

  #accepted-proposals-num {
    color: #33bc8b;
  }

  #rejected-proposals-num {
    color: #f8b03d;
  }

  .results-table ul {
    margin-left: 0;
    padding: 0;
    list-style-type: none;
    list-style-position: inside;
  }

  .results-title ul {
    margin-top: 20px;
  }

  .opt-filter {
    display: grid;
    grid-template-columns: auto 1fr;
  }

  .opt-filter-values {
    display: flex;
    align-items: center;
  }

  .opt-filter-value {
    padding: 10px;
  }

  .hidden {
    display: none;
  }
</style>

<script type="application/javascript">
  const submissions = [];
  const audienceLevels = [
    {% for audience_level in audience_levels %}
      "{{ audience_level.id }}",
    {% endfor %}
  ];

  let acceptedProposalsNumRef;
  let rejectedProposalsNumRef;

  const getRefs = () => {
    acceptedProposalsNumRef = document.querySelector("#accepted-proposals-num");
    rejectedProposalsNumRef = document.querySelector("#rejected-proposals-num");
  };

  window.addEventListener("load", () => {
    getRefs();
    updateBottomBarUI();

    submissions.forEach((submissionData) => {
      const submissionId = submissionData.id;
      const acceptInput = document.getElementById(
        `decision-${submissionId}-accept`,
      );
      const rejectInput = document.getElementById(
        `decision-${submissionId}-reject`,
      );
      const unsetInput = document.getElementById(
        `decision-${submissionId}-unset`,
      );

      acceptInput.addEventListener("change", () => {
        submissionData.status = "accepted";
        updateBottomBarUI();
      });

      rejectInput.addEventListener("change", () => {
        submissionData.status = "rejected";
        updateBottomBarUI();
      });

      unsetInput.addEventListener("change", () => {
        unsetInput.checked = false;
        submissionData.status = "unknown";
        updateBottomBarUI();
      });
    });

    const filterWithReviewsSelect = document.querySelector('#filter-with-n-reviews');
    filterWithReviewsSelect.addEventListener('change', e => {
      e.preventDefault();

      const filterValue = parseInt(e.target.value, 10);

      document.querySelectorAll('.grant-item').forEach(
        proposalItem => {
          if (e.target.value === 'all') {
            proposalItem.classList.remove('hidden')
            return;
          }

          const numOfVotes = parseInt(proposalItem.dataset.numOfVotes, 10);
          if (numOfVotes === filterValue) {
            proposalItem.classList.remove('hidden')
          } else {
            proposalItem.classList.add('hidden')
          }
        }
      )

    })
  });

  const updateBottomBarUI = () => {
    const acceptedAudienceLevels = {};
    const rejectedAudienceLevels = {};

    const results = submissions.reduce(
      (acc, submission) => {
        if (submission.status === "accepted") {
          acc[0]++;
          acceptedAudienceLevels[submission.audienceLevel] = (acceptedAudienceLevels[submission.audienceLevel] || 0) + 1;
        } else if (submission.status === "rejected") {
          acc[1]++;
          rejectedAudienceLevels[submission.audienceLevel] = (rejectedAudienceLevels[submission.audienceLevel] || 0) + 1;
        }
        return acc;
      },
      [0, 0],
    );

    acceptedProposalsNumRef.innerText = results[0];
    rejectedProposalsNumRef.innerText = results[1];

    audienceLevels.forEach(
      audienceLevel => {
        const acceptedRef = document.querySelector(`#accepted-audience-level-${audienceLevel}`);
        const rejectedRef = document.querySelector(`#rejected-audience-level-${audienceLevel}`);
        acceptedRef.innerText = acceptedAudienceLevels[audienceLevel] || 0;
        rejectedRef.innerText = rejectedAudienceLevels[audienceLevel] || 0;
      }
    );
  };
</script>

<form id="changelist-form" method="post" novalidate="">
  {% csrf_token %}

  <div id="content-main">
    <div class="module filtered" id="changelist">
      <div class="changelist-form-container">
        <div class="results">
          <table id="result_list" class="results-table">
            <thead>
              <tr>
                <th scope="col">
                  <div class="text"><a>Fullname</a></div>
                  <div class="clear"></div>
                </th>
                <th scope="col">
                  <div class="text"><a>Score</a></div>
                  <div class="clear"></div>
                </th>
                <th scope="col">
                  <div class="text"><a>Votes</a></div>
                  <div class="clear"></div>
                </th>
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr class="grant-item" id="grant-{{item.id}}" data-type="{{item.type}}" data-num-of-votes="{{ item.userreview_set.count }}">
                <td class="results-title">
                  <a
                    target="_blank"
                    href="{% url 'admin:grants_grant_change' item.id %}">
                    <strong>{{item.full_name}}</strong>
                  </a>

                <td>{{ item.score }}</td>

                <td>
                  <ul>
                    {% for reviewer in item.userreview_set.all %}
                    <li>
                      <strong>{{reviewer.user.full_name}}</strong> voted
                      {{reviewer.score.label}}
                      ({{reviewer.score.numeric_value}})<br />
                      {{reviewer.comment}}
                    </li>
                    {% empty %}
                    <li>No reviews yet</li>
                    {% endfor %}
                    <li>
                      <a style="font-weight: bold" target="_blank" href="{% url 'admin:reviews-vote-view' review_session_id=review_session_id review_item_id=item.id %}">
                        Vote this proposal
                      </a>
                    </li>
                  </ul>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div style="height: 100px"></div>
  </div>

</form>
{% endblock %}
